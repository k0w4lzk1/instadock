---
name: Build Submission Image

on:
  push:
    branches:
      - "submission/**"

permissions:
  contents: read
  packages: write

jobs:
  build-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect submission directory
        id: finddir
        run: |
          SUBDIR=$(find submissions -mindepth 2 -maxdepth 2 -type d | head -n 1)
          if [ -z "$SUBDIR" ]; then
            echo "Submission directory not found."
            exit 1
          fi
          echo "subpath=$SUBDIR" >> $GITHUB_OUTPUT
          echo "Found submission directory: $SUBDIR"

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          # Extract short submission ID from branch name
          SHORT_ID="${GITHUB_REF_NAME##*/}"
          
          IMAGE="ghcr.io/${{ github.repository_owner }}/instadock_${SHORT_ID}:latest"

          echo "Building image: $IMAGE"
          docker build -t "$IMAGE" "${{ steps.finddir.outputs.subpath }}"

          echo "Pushing image: $IMAGE"
          docker push "$IMAGE"

      - name: Notify backend (save built image)
        run: |
          SHORT_ID="${GITHUB_REF_NAME##*/}"
          PAYLOAD=$(jq -n \
            --arg sub "$SHORT_ID" \
            --arg img "instadock_${SHORT_ID}" \
            '{submission_id: $sub, image_tag: $img}')

          curl -X POST \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            http://localhost:8000/submission/image-callback
