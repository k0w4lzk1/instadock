name: üê≥ Build Submission Image

on:
  push:
    branches:
      - "submission/**"

permissions:
  contents: read
  packages: write

jobs:
  build-submission:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Determine submission directory
        id: subdir
        run: |
          # Example ref: submission/abcd1234/efgh5678
          BRANCH="${GITHUB_REF_NAME}"

          SUBUSER=$(echo "$BRANCH" | cut -d'/' -f2)
          SUBID=$(echo "$BRANCH" | cut -d'/' -f3)

          SUBPATH="submissions/$SUBUSER/$SUBID"

          echo "subpath=$SUBPATH" >> $GITHUB_OUTPUT

      - name: Verify submission folder exists
        run: |
          if [ ! -d "${{ steps.subdir.outputs.subpath }}" ]; then
            echo "‚ùå Submission directory not found!"
            exit 1
          fi

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build submission image
        run: |
          IMAGE="ghcr.io/${{ github.repository_owner }}/instadock_${GITHUB_REF_NAME##*/}:latest"
          docker build -t "$IMAGE" "${{ steps.subdir.outputs.subpath }}"
          docker push "$IMAGE"

